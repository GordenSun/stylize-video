<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gemini 2.5 Flash é£æ ¼åŒ– & å¹»ç¯ç‰‡è§†é¢‘ï¼ˆOpenRouterï¼Œæœ¬åœ°H5ï¼‰</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--card:#0b1220}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1329 40%,#0a0f1a);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:20px 16px 8px;display:flex;justify-content:space-between;align-items:center}
    h1{font-size:18px;margin:0} a{color:var(--accent)}
    .wrap{max-width:1000px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:radial-gradient(1200px 400px at -10% -10%,rgba(34,211,238,.1),transparent 40%),radial-gradient(1200px 400px at 110% 110%,rgba(34,197,94,.08),transparent 40%),var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 6px 22px rgba(0,0,0,.35)}
    .card h2{font-size:16px;margin:0;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
    .card .body{padding:14px 16px}
    label{display:block;margin:.5rem 0 .25rem;color:var(--muted)}
    input[type=text],input[type=password],select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0b1120;color:var(--text)}
    input[type=file]{border:1px dashed rgba(255,255,255,.25);padding:16px;border-radius:12px;width:100%;background:#0b1120;color:var(--muted)}
    button{cursor:pointer;background:linear-gradient(90deg,#22d3ee,#22c55e);border:none;color:#02111a;font-weight:700;letter-spacing:.2px}
    button[disabled]{filter:grayscale(1);opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.1);background:#0b1120;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .thumb{position:relative;background:#000;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
    .thumb img{display:block;width:100%;height:160px;object-fit:cover}
    .thumb a{position:absolute;left:8px;right:8px;bottom:8px;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);padding:6px 8px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,.2)}
    .log{max-height:220px;overflow:auto;background:#0b1120;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    progress{width:100%;height:14px}
    footer{padding:20px 16px;color:var(--muted);text-align:center}
    .tiny{font-size:12px}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Gemini 2.5 Flash æœ¬åœ°é£æ ¼åŒ– & å¹»ç¯ç‰‡è§†é¢‘ï¼ˆOpenRouterï¼‰</h1>
    <div class="tiny">çº¯å‰ç«¯æœ¬åœ°è¿è¡Œ Â· API ç›´è¿ OpenRouter Â· å¯†é’¥ä¸ä¿å­˜ï¼Œæ¯æ¬¡æ‰‹åŠ¨è¾“å…¥</div>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šè®¾ç½®ä¸æ“ä½œ -->
    <section class="card">
      <h2>1) é…ç½® & ç”Ÿæˆ</h2>
      <div class="body">
        <label>OpenRouter API Keyï¼ˆä¸ä¼šä¿å­˜ï¼‰</label>
        <input id="apiKey" type="password" placeholder="sk-or-v1-..." />

        <label style="margin-top:10px">ä¸Šä¼ åŸå›¾ï¼ˆå»ºè®® â‰¤ 2K åˆ†è¾¨ç‡ï¼ŒJPG/PNGï¼‰</label>
        <input id="inputImage" type="file" accept="image/*" />

        <label style="margin-top:10px">é£æ ¼é€‰æ‹©</label>
        <div class="tiny muted">å°†ä»å†…ç½®é£æ ¼åº“ä¸­<span style="font-weight:700;color:#e5e7eb">éšæœºé€‰æ‹© 10 ä¸ªä¸é‡å¤</span>çš„é£æ ¼è¿›è¡Œç”Ÿæˆã€‚</div>

        <label style="margin-top:10px">é€‰æ‹©æœ¬åœ°èƒŒæ™¯éŸ³ä¹ï¼ˆå¯é€‰ï¼‰</label>
        <input id="bgmFile" type="file" accept="audio/mpeg,audio/mp3,audio/*" />
        <div class="tiny muted">æœªé€‰æ‹©åˆ™å°è¯•åŒç›®å½• <b>bgm.mp3</b>ã€‚å¦‚ä»¥ <code>file://</code> æ‰“å¼€é¡µé¢ï¼ŒéŸ³é¢‘å¯èƒ½è¢« CORS æ‹¦æˆªï¼Œå»ºè®®é€‰æ‹©æœ¬åœ° MP3 æˆ–ç”¨æœ¬åœ°æœåŠ¡å™¨ï¼ˆå¦‚ http://localhostï¼‰ã€‚</div>

        <div style="margin-top:14px" class="row">
          <button id="startBtn">å¼€å§‹ç”Ÿæˆï¼ˆ10 å¼ ï¼‰å¹¶åˆæˆ 10 ç§’è§†é¢‘</button>
        </div>

        <div style="margin-top:14px">
          <label>è¿›åº¦</label>
          <progress id="prog" value="0" max="100"></progress>
          <div id="log" class="log tiny" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <!-- å³ï¼šç»“æœé¢„è§ˆ -->
    <section class="card">
      <h2>2) ç»“æœ & ä¸‹è½½</h2>
      <div class="body">
        <div style="margin-bottom:12px">
          <div class="muted tiny">åŸå›¾é¢„è§ˆ</div>
          <div class="thumb" style="height:220px">
            <img id="origPreview" alt="åŸå›¾é¢„è§ˆ" style="height:220px;object-fit:contain;background:#000" />
          </div>
        </div>
        <div>
          <div class="muted tiny">10 å¼ é£æ ¼åŒ–å›¾ç‰‡</div>
          <div id="gallery" class="gallery"></div>
        </div>
        <div style="margin-top:12px">
          <div class="muted tiny">åˆæˆè§†é¢‘ï¼ˆ10sï¼Œ30fpsï¼ŒWebM + Opusï¼‰</div>
          <video id="videoOut" controls playsinline style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.1)"></video>
          <div class="row" style="margin-top:8px">
            <a id="dlVideo" class="pill" download="stylized_slideshow.webm">ä¸‹è½½è§†é¢‘</a>
            <a id="dlOrig" class="pill" download="original.jpg">ä¸‹è½½åŸå›¾</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="tiny">è§†é¢‘ <b>11 ç§’</b>ï¼ˆæ¯å¼  1sï¼Œå« 0.2s æ“¦é™¤è¿‡æ¸¡ï¼‰ã€‚è§†é¢‘å·²åŒ…å«ï¼š<b>åŸå›¾ + 10 å¼ é£æ ¼å›¾ï¼ˆå…± 11 å¼ ï¼‰</b>ã€‚ç”Ÿæˆçš„ 10 å¼ é£æ ¼å›¾å‡å¯å•ç‹¬ä¸‹è½½ã€‚</div>
  </footer>

  <audio id="bgm" src="bgm.mp3"></audio>
  <canvas id="stage" width="1280" height="720" style="display:none"></canvas>

<script>
(function(){
  const MODEL_ID = 'google/gemini-2.5-flash-image-preview:free';
  const STYLES = [
    'å“¥ç‰¹æš—é»‘','Big-head cartoon','Vaporwave','Airbrush Art','Sumi-e / Ink Wash Painting','Linocut / Woodcut','Psychedelic Art','Pre-Raphaelite Brotherhood','Tenebrism / Chiaroscuro','Russian Constructivism','èµ›åšæœ‹å…‹','Vienna Secession','Art Nouveau','80\'s Anime Grill','ç™½è‰²çš„é›•å¡‘','Bauhaus Style','è‡ªç”±å‘æŒ¥','å¤šç§è§å…‰è‰²','Jackson Pollock','Double Exposure','roy lichtenstein','Fauvism','ç¾å¼æ¼«ç”»','èµ›ç’ç’åŠ¨ç”»','æµ®ä¸–ç»˜','Takeda Hiromitsu','Flat Color','é»‘ç™½åŠ¨æ¼«çº¿ç¨¿','æ–°æµ·è¯š','JOJOå¥‡å¦™å†’é™©','å‰åœåŠ›'
  ];

  const USE_ORIGINAL_IN_VIDEO = true;
  const SLIDE_COUNT = 10;
  const FPS = 30;
  const TOTAL_SECONDS = 11;
  const PER_SLIDE_MS = 1000;
  const TRANSITION_MS = 200;
  const CANVAS_W = 1280, CANVAS_H = 720;

  // æ–°å¢ï¼šè¯·æ±‚å¯åŠ¨é—´éš”ï¼ˆæ¯«ç§’ï¼‰ä¸ 429 é‡è¯•
  const RATE_DELAY_MS = 1200; // æ¯æ¬¡çœŸæ­£å‘èµ·è¯·æ±‚ä¹‹é—´è‡³å°‘é—´éš” 1.2sï¼ˆå¯è‡ªè¡Œè°ƒæ•´ï¼‰
  const MAX_RETRY_429 = 3;    // 429 æ—¶æœ€å¤šé‡è¯• 3 æ¬¡ï¼ˆæŒ‡æ•°é€€é¿ + æŠ–åŠ¨ï¼‰

  const el = (id)=>document.getElementById(id);
  const apiKeyInput = el('apiKey');
  const inputImage = el('inputImage');
  const startBtn = el('startBtn');
  const logBox = el('log');
  const prog = el('prog');
  const gallery = el('gallery');
  const origPreview = el('origPreview');
  const videoOut = el('videoOut');
  const dlVideo = el('dlVideo');
  const dlOrig = el('dlOrig');
  const stage = el('stage');
  const bgm = el('bgm');
  const bgmFile = el('bgmFile');
  const ctx = stage.getContext('2d');

  stage.width = CANVAS_W; stage.height = CANVAS_H;

  inputImage.onchange = async ()=>{
    const f = inputImage.files?.[0];
    if(!f) return;
    const dataURL = await fileToDataURL(f);
    origPreview.src = dataURL;
    dlOrig.href = dataURL;
    dlOrig.download = f.name || 'original.jpg';
  };

  // å…è®¸é€‰æ‹©æœ¬åœ° BGMï¼Œé¿å… file:// åœºæ™¯ä¸‹çš„ CORS æ‹¦æˆª
  if(bgmFile){
    bgmFile.onchange = ()=>{
      const f = bgmFile.files?.[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      bgm.src = url;
      toast('ğŸµ å·²åŠ è½½æœ¬åœ° BGMï¼ˆblob: URLï¼Œæ— éœ€ CORSï¼‰','ok');
    };
  }

  startBtn.onclick = async ()=>{
    if(startBtn.disabled) return; // é˜²æŠ–
    try{
      startBtn.disabled = true;
      const originalText = startBtn.textContent;
      startBtn.textContent = 'æ­£åœ¨ç”Ÿæˆâ€¦';

      gallery.innerHTML = '';
      videoOut.removeAttribute('src'); videoOut.load();
      dlVideo.removeAttribute('href');
      prog.value = 0; logBox.innerHTML = '';

      const apiKey = apiKeyInput.value.trim();
      if(!apiKey) throw new Error('è¯·å…ˆå¡«å†™ OpenRouter API Key');
      const f = inputImage.files?.[0];
      if(!f) throw new Error('è¯·å…ˆä¸Šä¼ ä¸€å¼ åŸå›¾');

      if(location.protocol === 'file:' && !bgmFile?.files?.[0]){
        toast('â„¹ï¸ å½“å‰ä¸º file:// æ‰“å¼€ï¼Œè‹¥éŸ³é¢‘å—é™è¯·é€‰æ‹©æœ¬åœ° BGM æˆ–ç”¨æœ¬åœ°æœåŠ¡å™¨','warn');
      }

      const srcDataURL = await fileToDataURL(f);
      origPreview.src = srcDataURL;

      // éšæœºé€‰æ‹© 10 ä¸ªä¸é‡å¤é£æ ¼
      const selected = shuffle([...STYLES]).slice(0, SLIDE_COUNT);
      // å¸¦æœ€å°å¯åŠ¨é—´éš”çš„å¹¶å‘æ§åˆ¶ï¼šä½¿ç”¨ pLimit(2) + rateGate() ä¿è¯æ¯æ¬¡â€œå¼€å§‹è¯·æ±‚â€çš„æ—¶é—´è‡³å°‘ç›¸éš” RATE_DELAY_MS
      const limiter = pLimit(2);
      let done = 0; prog.value = 0;
      const tasks = selected.map((style,idx)=> limiter(async ()=>{
        await rateGate();
        const prompt = `ä¿æŒæ„å›¾ä¸å˜ï¼Œä¿æŒäººç‰©ä½ç½®ä¸å˜(éå¸¸é‡è¦ï¼ï¼ï¼)ï¼ŒæŠŠå›¾ç‰‡å˜æˆ${style}é£æ ¼ï¼Œæ³¨æ„è¦åŒæ—¶ä¿®æ”¹äººç‰©çš„é¢éƒ¨ä¸ºå¯¹åº”çš„é£æ ¼ï¼Œé£æ ¼æ”¹å˜è¦éå¸¸æ˜æ˜¾ã€‚`;
        try{
          const imgDataUrl = await callOpenRouterImageEdit({apiKey, model: MODEL_ID, prompt, imageDataURL: srcDataURL});
          done++; prog.value = Math.round(done/(SLIDE_COUNT)*60);
          addThumb(imgDataUrl, idx, style);
          return {style, dataURL: imgDataUrl};
        }catch(e){
          toast(`âš ï¸ ç¬¬${idx+1}å¼ ç”Ÿæˆå¤±è´¥ï¼š${e?.message||e}`,'warn');
          return null; // ä¸ä¸­æ–­æµç¨‹
        }
      }));

      const results = await Promise.all(tasks);
      const ok = results.filter(r => r && r.dataURL);
      if(ok.length === 0) throw new Error('å…¨éƒ¨å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–ç¨åå†è¯•');

      // å°†æˆåŠŸçš„ç»“æœå‡‘æ»¡åˆ° 10 å¼ ï¼ˆè‹¥ä¸è¶³åˆ™ç”¨æœ€åä¸€å¼ è¡¥é½ï¼‰
      let stylized = ok.map(r=>r.dataURL);
      if(stylized.length < SLIDE_COUNT){
        const need = SLIDE_COUNT - stylized.length;
        const fill = new Array(need).fill(stylized[stylized.length-1] || stylized[0]);
        stylized = stylized.concat(fill);
        toast(`âš ï¸ ä»…æˆåŠŸ ${ok.length} å¼ ï¼Œå·²è‡ªåŠ¨è¡¥é½åˆ° ${SLIDE_COUNT} å¼ å¹¶ç»§ç»­åˆæˆè§†é¢‘`,'warn');
      }

      toast('ğŸï¸ å¼€å§‹åˆæˆè§†é¢‘ï¼ˆå¸¦ BGMï¼‰â€¦');
      const frames = USE_ORIGINAL_IN_VIDEO ? [srcDataURL, ...stylized] : stylized;
      const videoBlob = await renderSlideshowVideo(frames, {fps: FPS, totalSeconds: TOTAL_SECONDS, perSlideMs: PER_SLIDE_MS, transitionMs: TRANSITION_MS});
      const vurl = URL.createObjectURL(videoBlob);
      videoOut.src = vurl; videoOut.load();
      dlVideo.href = vurl;
      prog.value = 100;
      toast('âœ… å®Œæˆï¼å¯ä¸‹è½½ 10 å¼ é£æ ¼å›¾ä¸åˆæˆè§†é¢‘ã€‚','ok');

      startBtn.textContent = originalText;
      startBtn.disabled = false;
    }catch(err){
      console.error(err);
      toast('âŒ '+(err?.message||String(err)),'err');
      startBtn.textContent = 'å¼€å§‹ç”Ÿæˆï¼ˆ10 å¼ ï¼‰å¹¶åˆæˆ 10 ç§’è§†é¢‘';
      startBtn.disabled = false; // å¤±è´¥ä¹Ÿæ¢å¤
    }
  };

  // === é€Ÿç‡é—¨æ§ï¼ˆä¿è¯è¯·æ±‚å¯åŠ¨é—´éš”ï¼‰ ===
  let nextStart = 0;
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function rateGate(){
    const now = Date.now();
    const wait = Math.max(0, nextStart - now);
    if(wait > 0) await sleep(wait);
    nextStart = Math.max(now, nextStart) + RATE_DELAY_MS;
  }

  // === å·¥å…·å‡½æ•° ===
  function addThumb(dataURL, idx, style){
    const wrap = document.createElement('div'); wrap.className='thumb';
    const img = new Image(); img.src = dataURL; img.alt = style; img.loading='lazy';
    wrap.appendChild(img);
    const a = document.createElement('a'); a.textContent = `ä¸‹è½½ #${idx+1}`; a.download = `stylized_${String(idx+1).padStart(2,'0')}.png`; a.href = dataURL; wrap.appendChild(a);
    gallery.appendChild(wrap);
  }
  function toast(msg,type){
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    if(type==='ok') line.classList.add('ok');
    else if(type==='warn') line.classList.add('warn');
    else if(type==='err') line.classList.add('err');
    logBox.appendChild(line); logBox.scrollTop = logBox.scrollHeight;
  }
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a;
  }
  function pLimit(n){
    const queue=[]; let active=0;
    const next=()=>{ if(active>=n||queue.length===0) return; active++; const {fn,resolve,reject}=queue.shift(); fn().then(v=>{active--;resolve(v);next();}).catch(e=>{active--;reject(e);next();}); };
    return fn=> new Promise((resolve,reject)=>{ queue.push({fn,resolve,reject}); next(); });
  }
  async function fileToDataURL(file){
    const buf = await file.arrayBuffer();
    const b64 = arrayBufferToBase64(buf);
    return `data:${file.type||'image/png'};base64,${b64}`;
  }
  function arrayBufferToBase64(buffer){
    let binary=''; const bytes=new Uint8Array(buffer); const len=bytes.byteLength;
    for(let i=0;i<len;i++){ binary+=String.fromCharCode(bytes[i]); }
    return btoa(binary);
  }

  // === OpenRouter è°ƒç”¨ï¼ˆå« 429 é‡è¯•ï¼‰ ===
  async function callOpenRouterImageEdit(args, attempt=0){
    const {apiKey, model, prompt, imageDataURL} = args;
    const headers = {
      'Authorization': 'Bearer '+apiKey,
      'Content-Type': 'application/json'
    };
    const body = { model, messages: [ { role: 'user', content: [ { type: 'text', text: prompt }, { type: 'image_url', image_url: { url: imageDataURL } } ] } ] };
    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', { method: 'POST', headers, body: JSON.stringify(body) });

    if(res.status === 429){
      if(attempt >= MAX_RETRY_429) throw new Error('è§¦å‘é€Ÿç‡é™åˆ¶ï¼ˆ429ï¼‰ï¼Œé‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™');
      const backoff = Math.min(2000 * Math.pow(2, attempt), 8000) + Math.random()*400; // 2s,4s,8s + æŠ–åŠ¨
      toast(`â³ é€Ÿç‡é™åˆ¶ï¼Œ${Math.round(backoff)}ms åé‡è¯•ï¼ˆç¬¬ ${attempt+1} æ¬¡ï¼‰â€¦`,'warn');
      await sleep(backoff);
      return callOpenRouterImageEdit(args, attempt+1);
    }

    if(!res.ok){
      const t = await res.text().catch(()=> '');
      throw new Error('OpenRouter é”™è¯¯ï¼š'+res.status+' '+t);
    }

    const data = await res.json();
    const url = data?.choices?.[0]?.message?.images?.[0]?.image_url?.url;
    if(url && /^data:image\//.test(url)) return url;
    const alt = deepFindDataURL(data); if(alt) return alt;
    throw new Error('æœªè·å–åˆ°ç”Ÿæˆå›¾ç‰‡çš„ data URL');
  }
  function deepFindDataURL(obj){
    try{ const s = JSON.stringify(obj); const m = s.match(/data:image\/(?:png|jpeg|jpg|webp);base64,[A-Za-z0-9+/=]+/); return m ? m[0] : null; }catch{ return null; }
  }

  // æ›´ç¨³å¥åœ°ä» OpenRouter å“åº”ä¸­æå– data URLï¼ˆå…¼å®¹å¤šç§ç»“æ„ï¼‰
  function extractDataURLFromOpenRouter(data){
    try{
      const msg = data?.choices?.[0]?.message;
      // 1) å®˜æ–¹ç¤ºä¾‹ï¼šmessage.images[0].image_url.url
      const viaImages = msg?.images?.[0]?.image_url?.url;
      if(typeof viaImages === 'string' && viaImages.startsWith('data:image/')) return viaImages;
      // 2) content ä¸ºæ•°ç»„æ—¶ï¼Œå¯èƒ½åµŒå…¥ image_url / image_base64
      if(Array.isArray(msg?.content)){
        for(const part of msg.content){
          if(part?.image_url?.url && String(part.image_url.url).startsWith('data:image/')) return part.image_url.url;
          if(typeof part?.url === 'string' && part.url.startsWith('data:image/')) return part.url;
          if(part?.image_base64){ return 'data:image/png;base64,'+part.image_base64; }
        }
      }
      // 3) å…œåº•ï¼šå…¨æ–‡æ‰«æ base64 data URL
      const alt = deepFindDataURL(data); if(alt) return alt;
      return null;
    }catch{ return null; }
  }

  // === å¹»ç¯ç‰‡è§†é¢‘åˆæˆ ===
  async function renderSlideshowVideo(frameDataURLs, {fps, totalSeconds, perSlideMs, transitionMs}){
    const videoStream = stage.captureStream(fps);
    bgm.loop = true;
    let audioStream = null;
    try{
      if(bgm.src){
        await bgm.play();
        audioStream = (bgm.captureStream && bgm.captureStream()) ? bgm.captureStream() : null;
      }
    }catch(e){ toast('âš ï¸ éŸ³é¢‘æ’­æ”¾è¢«æ‹¦æˆªæˆ–åŠ è½½å¤±è´¥ï¼Œå°†å¯¼å‡ºæ— éŸ³è½¨è§†é¢‘','warn'); }
    const combined = audioStream ? new MediaStream([videoStream.getVideoTracks()[0], ...audioStream.getAudioTracks()]) : videoStream;
    

    const mime = selectSupportedMime();
    const rec = new MediaRecorder(combined, {mimeType: mime||undefined, videoBitsPerSecond: 6_000_000});
    const chunks=[]; rec.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
    const done = new Promise(resolve=>{ rec.onstop=()=> resolve(new Blob(chunks, {type: mime||'video/webm'})); });

    rec.start();
    await animateSlides(frameDataURLs, {fps, totalSeconds, perSlideMs, transitionMs});
    rec.stop(); if(audioStream){ bgm.pause(); bgm.currentTime = 0; }
    return await done;
  }
  function selectSupportedMime(){
    const cands = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm'];
    for(const m of cands){ if(MediaRecorder.isTypeSupported(m)) return m; } return '';
  }
  async function animateSlides(frameURLs, {fps, totalSeconds, perSlideMs, transitionMs}){
    const imgs = await Promise.all(frameURLs.map(loadImage));
    const frameTotal = Math.round(totalSeconds * fps);
    const frameDur = 1000 / fps; const slides = imgs.length;
    const startTime = performance.now(); let lastDrawn = -1;

    return new Promise(resolve=>{
      const loop = (now)=>{
        const elapsed = now - startTime; const t = Math.min(elapsed, totalSeconds*1000);
        const frameIndex = Math.floor(t / frameDur);
        if(frameIndex === lastDrawn){ requestAnimationFrame(loop); return; }
        lastDrawn = frameIndex;

        const currentSlide = Math.min(Math.floor(t / perSlideMs), slides-1);
        const slideStart = currentSlide * perSlideMs; const within = t - slideStart;
        const transition = Math.max(0, within - (perSlideMs - transitionMs));
        const progress = Math.min(1, transition / transitionMs);
        const directionLeft = (currentSlide % 2 === 0);

        ctx.fillStyle = '#000'; ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
        drawContain(ctx, imgs[currentSlide], CANVAS_W, CANVAS_H);
        if(currentSlide < slides-1 && progress > 0){
          ctx.save(); const w = Math.floor(CANVAS_W * progress);
          if(directionLeft){ ctx.beginPath(); ctx.rect(CANVAS_W - w, 0, w, CANVAS_H); ctx.clip(); }
          else { ctx.beginPath(); ctx.rect(0, 0, w, CANVAS_H); ctx.clip(); }
          drawContain(ctx, imgs[currentSlide+1], CANVAS_W, CANVAS_H); ctx.restore();
        }
        if(frameIndex < frameTotal){ requestAnimationFrame(loop); } else { resolve(); }
      }; requestAnimationFrame(loop);
    });
  }
  function drawContain(ctx, img, W, H){
    const iw = img.naturalWidth || img.width, ih = img.naturalHeight || img.height;
    const r = Math.min(W/iw, H/ih); const nw = Math.round(iw*r), nh = Math.round(ih*r);
    const x = Math.floor((W-nw)/2), y = Math.floor((H-nh)/2);
    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, x, y, nw, nh);
  }
  function loadImage(url){
    return new Promise((resolve,reject)=>{ const im=new Image(); im.onload=()=>resolve(im); im.onerror=()=>reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥')); im.src=url; });
  }
})();
</script>
</body>
</html>
